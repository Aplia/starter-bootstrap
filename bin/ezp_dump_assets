#!/usr/bin/env php
<?php
require_once __DIR__ . '/../../../../config.php';
require_once __DIR__ . '/../../../../autoload.php';

$cli = \eZCLI::instance();
$script = \eZScript::instance(
    array(
        'description' => "Lists all assets configured by extensions\n",
        'use-session' => false,
        'use-modules' => false,
        'use-extensions' => true
    )
);

$script->startup();
$options = $script->getOptions("[hide-missing]", "", array(
    'hide-missing' => 'Hide warning about missing assets',
));
$script->initialize();

$showMissing = !$options['hide-missing'];

$basePath = \eZExtension::baseDirectory();
$designIni = \eZINI::instance('design.ini');
$assets = array(
    'frontendCss' => array(
        'type' => 'css',
        'path' => 'css/frontend.css',
        'files' => array_merge(
            $designIni->hasVariable('StylesheetSettings', 'PreFrontendCSSFileList') ? $designIni->variable('StylesheetSettings', 'PreFrontendCSSFileList') : array(),
            $designIni->hasVariable('StylesheetSettings', 'FrontendCSSFileList') ? $designIni->variable('StylesheetSettings', 'FrontendCSSFileList') : array(),
            $designIni->hasVariable('StylesheetSettings', 'PostFrontendCSSFileList') ? $designIni->variable('StylesheetSettings', 'PostFrontendCSSFileList') : array()
        ),
    ),
    'frontendJs' => array(
        'type' => 'js',
        'path' => 'js/frontend.js',
        'files' => array_merge(
            $designIni->hasVariable('JavaScriptSettings', 'PreFrontendJavaScriptList') ? $designIni->variable('JavaScriptSettings', 'PreFrontendJavaScriptList') : array(),
            $designIni->hasVariable('JavaScriptSettings', 'FrontendJavaScriptList') ? $designIni->variable('JavaScriptSettings', 'FrontendJavaScriptList') : array(),
            $designIni->hasVariable('JavaScriptSettings', 'PostFrontendJavaScriptList') ? $designIni->variable('JavaScriptSettings', 'PostFrontendJavaScriptList') : array()
        ),
    ),
    'backendCss' => array(
        'type' => 'js',
        'path' => 'css/backend.css',
        'files' => array_merge(
            $designIni->hasVariable('StylesheetSettings', 'PreBackendCSSFileList') ? $designIni->variable('StylesheetSettings', 'PreBackendCSSFileList') : array(),
            $designIni->hasVariable('StylesheetSettings', 'BackendCSSFileList') ? $designIni->variable('StylesheetSettings', 'BackendCSSFileList') : array(),
            $designIni->hasVariable('StylesheetSettings', 'PostBackendCSSFileList') ? $designIni->variable('StylesheetSettings', 'PostBackendCSSFileList') : array()
        ),
    ),
    'backendJs' => array(
        'type' => 'js',
        'path' => 'js/backend.js',
        'files' => array_merge(
            $designIni->hasVariable('JavaScriptSettings', 'PreBackendJavaScriptList') ? $designIni->variable('JavaScriptSettings', 'PreBackendJavaScriptList') : array(),
            $designIni->hasVariable('JavaScriptSettings', 'BackendJavaScriptList') ? $designIni->variable('JavaScriptSettings', 'BackendJavaScriptList') : array(),
            $designIni->hasVariable('JavaScriptSettings', 'PostBackendJavaScriptList') ? $designIni->variable('JavaScriptSettings', 'PostBackendJavaScriptList') : array()
        ),
    ),
    'editorCss' => array(
        'type' => 'css',
        'path' => 'css/editor.css',
        'files' => $designIni->variable('StylesheetSettings', 'EditorCSSFileList'),
    ),
);

function print_error($msg, $eol=true)
{
    fwrite(STDERR, $msg . ($eol ? "\n" : ""));
}

$bundleManager = new \Aplia\Bundle\Manager($assets);
$bundleManager->expandAssets();

$jsonOpts = version_compare(PHP_VERSION, '5.4.0') >= 0 ? (JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE) : 0;

echo json_encode(array('bundles' => $bundleManager->bundles), $jsonOpts), "\n";

if ($showMissing) {
    if ($bundleManager->missingAssets) {
        print_error("The following files could not be found:");
        foreach ($bundleManager->missingAssets as $missingAsset) {
            print_error("- " . $missingAsset['file']);
        }
    }
}
