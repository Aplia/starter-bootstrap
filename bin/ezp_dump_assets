#!/usr/bin/env php
<?php
require_once __DIR__ . '/../../../../config.php';
require_once __DIR__ . '/../../../../autoload.php';

$cli = \eZCLI::instance();
$script = \eZScript::instance(
    array(
        'description' => "Lists all assets configured by extensions\n",
        'use-session' => false,
        'use-modules' => false,
        'use-extensions' => true
    )
);

$script->startup();
$options = $script->getOptions("[hide-missing]", "", array(
    'hide-missing' => 'Hide warning about missing assets',
));
$script->initialize();

$showMissing = !$options['hide-missing'];

function print_error($msg, $eol=true)
{
    fwrite(STDERR, $msg . ($eol ? "\n" : ""));
}

$bundleManager = new \Aplia\Bundle\Manager();
$bundleManager->discoverAssets();

$jsonOpts = version_compare(PHP_VERSION, '5.4.0') >= 0 ? (JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE) : 0;

echo json_encode(array('bundles' => $bundleManager->bundles), $jsonOpts), "\n";

if ($showMissing) {
    if ($bundleManager->missingAssets) {
        print_error("The following files could not be found:");
        foreach ($bundleManager->missingAssets as $missingAsset) {
            print_error("- " . $missingAsset['file']);
        }
    }
}
